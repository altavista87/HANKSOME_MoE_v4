<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant | EngramHANK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a5f',
                        secondary: '#2c5282',
                        accent: '#3182ce',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chat-container { height: calc(100vh - 200px); }
        .message-bubble { max-width: 80%; word-wrap: break-word; }
        .typing-indicator span { animation: blink 1.4s infinite both; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0.2; } 50% { opacity: 1; } }
        .suggested-question { transition: all 0.2s; }
        .suggested-question:hover { background-color: #e0e7ff; }
        .api-status { font-size: 0.75rem; }
        .api-status.connected { color: #10b981; }
        .api-status.disconnected { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="../index.html" class="text-gray-600 hover:text-gray-900 mr-4">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <div class="ml-3">
                        <h1 class="font-semibold text-gray-900">EngramHANK Assistant</h1>
                        <p class="text-xs text-gray-500">Powered by Cerebras AI</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="api-status" class="api-status disconnected">
                        <i class="fas fa-circle text-xs mr-1"></i>
                        <span>API Key Required</span>
                    </div>
                    <button onclick="toggleApiKey()" class="text-sm text-primary hover:text-secondary">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Cerebras API Configuration</h3>
            <p class="text-sm text-gray-600 mb-4">
                Enter your Cerebras API key to enable AI-powered responses. 
                Your key is stored locally in your browser and never sent to our servers.
            </p>
            <input type="password" id="api-key-input" placeholder="csk-..." 
                   class="w-full px-4 py-2 border rounded-lg mb-4 font-mono text-sm">
            <div class="flex gap-2">
                <button onclick="saveApiKey()" class="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-secondary">
                    Save Key
                </button>
                <button onclick="toggleApiKey()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-3">
                Don't have a key? <a href="https://cloud.cerebras.ai/" target="_blank" class="text-primary hover:underline">Get one free</a>
            </p>
        </div>
    </div>

    <!-- Main Chat -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Messages Area -->
            <div id="chat-messages" class="chat-container overflow-y-auto p-6 space-y-4">
                <!-- Welcome Message -->
                <div class="flex items-start">
                    <div class="w-8 h-8 bg-gradient-to-br from-primary to-accent rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="ml-3 message-bubble bg-gray-100 rounded-lg p-4">
                        <p class="text-gray-800">
                            Hello! I'm your EngramHANK research assistant, powered by <strong>Cerebras AI</strong>. I can help you understand:
                        </p>
                        <ul class="mt-2 text-sm text-gray-600 list-disc list-inside">
                            <li>Malaysian economic shock results</li>
                            <li>Model methodology and calibration</li>
                            <li>Policy implications and recommendations</li>
                            <li>Comparisons between different shocks</li>
                        </ul>
                        <p class="mt-3 text-sm text-gray-600">
                            <i class="fas fa-key mr-1"></i>
                            Click the <strong>gear icon</strong> above to add your Cerebras API key for enhanced AI responses.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Suggested Questions -->
            <div class="border-t bg-gray-50 px-6 py-3">
                <p class="text-xs text-gray-500 mb-2">Suggested questions:</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="askQuestion('What was the most severe economic shock for Malaysia?')" 
                            class="suggested-question px-3 py-1.5 bg-white border rounded-full text-sm text-gray-700 hover:border-primary">
                        Most severe shock?
                    </button>
                    <button onclick="askQuestion('Compare COVID lockdown vs GFC impact')" 
                            class="suggested-question px-3 py-1.5 bg-white border rounded-full text-sm text-gray-700 hover:border-primary">
                        COVID vs GFC
                    </button>
                    <button onclick="askQuestion('What are the key transmission channels?')" 
                            class="suggested-question px-3 py-1.5 bg-white border rounded-full text-sm text-gray-700 hover:border-primary">
                        Transmission channels
                    </button>
                    <button onclick="askQuestion('What policy recommendations emerge from this analysis?')" 
                            class="suggested-question px-3 py-1.5 bg-white border rounded-full text-sm text-gray-700 hover:border-primary">
                        Policy recommendations
                    </button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t p-4">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="user-input" 
                           placeholder="Ask about Malaysian economic shocks..."
                           class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <button type="submit" 
                            class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
                <p class="text-xs text-gray-400 mt-2 text-center">
                    AI responses powered by Cerebras. 
                    <a href="../malaysia/index.html" class="text-primary hover:underline">View full data</a>
                </p>
            </div>
        </div>

        <!-- Data Reference Card -->
        <div class="mt-6 bg-white rounded-xl shadow p-6">
            <h3 class="font-semibold text-gray-900 mb-3">Quick Reference</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div class="p-3 bg-red-50 rounded-lg border border-red-100">
                    <div class="text-red-600 font-bold text-lg">48%</div>
                    <div class="text-gray-600">Tourism Collapse</div>
                </div>
                <div class="p-3 bg-orange-50 rounded-lg border border-orange-100">
                    <div class="text-orange-600 font-bold text-lg">15%</div>
                    <div class="text-gray-600">GFC Impact</div>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                    <div class="text-primary font-bold text-lg">20</div>
                    <div class="text-gray-600">Shocks Analyzed</div>
                </div>
                <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                    <div class="text-green-600 font-bold text-lg">17q</div>
                    <div class="text-gray-600">Gig Economy HL</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Cerebras API Configuration
        const CEREBRAS_API_URL = 'https://api.cerebras.ai/v1/chat/completions';
        let apiKey = localStorage.getItem('cerebras_api_key') || '';
        
        // Knowledge Base for offline responses
        const knowledgeBase = {
            'most severe': {
                keywords: ['most severe', 'worst', 'biggest impact', 'largest'],
                response: `The **Tourism Collapse (2020-2022)** was the most severe shock with a **48% peak output impact** â€” more than 3Ã— larger than the Global Financial Crisis (15%).

Key facts:
â€¢ Affected 83% of tourist arrivals
â€¢ Services GDP dropped 25%
â€¢ Urban employment fell 8%
â€¢ Recovery was relatively quick (2 quarter half-life)`
            },
            'covid': {
                keywords: ['covid', 'lockdown', 'pandemic'],
                response: `**COVID Lockdown (Q2 2020)** produced a **9.6% peak output impact** with unique characteristics:

â€¢ Extremely fast onset (immediate impact)
â€¢ Short half-life (1 quarter) due to adaptation
â€¢ Employment loss of 2.4%
â€¢ Hours worked dropped 25%

The model shows TFP shocks have high initial impact but quick recovery.`
            },
            'gfc': {
                keywords: ['gfc', 'financial crisis', '2008', '2009'],
                response: `The **Global Financial Crisis (2008-2009)** had a **15% peak output impact**:

â€¢ 3 quarter half-life (moderate persistence)
â€¢ External demand shock through export channel
â€¢ Peak consumption impact: 15.6%

Despite smaller magnitude than Tourism Collapse, GFC had broader economy-wide effects.`
            },
            'transmission': {
                keywords: ['transmission', 'channel', 'how', 'mechanism'],
                response: `The model identifies **8 transmission channels**:

1. **External Demand** (5 shocks): Export channel â€” most frequent
2. **TFP/Supply** (4 shocks): Quick recovery but high initial hit
3. **Fiscal/Tax** (2 shocks): High persistence (8 quarters)
4. **Monetary Policy** (2 shocks): Gradual transmission (6-8 quarters)
5. **Terms of Trade** (2 shocks): Energy & palm oil volatility
6. **Exchange Rate** (1 shock): Import price effects
7. **Sectoral** (1 shock): Tourism-specific
8. **Risk/Uncertainty** (2 shocks): Longest-lasting effects`
            },
            'policy': {
                keywords: ['policy', 'recommendation', 'what should', 'bnm', 'government'],
                response: `**Key Policy Recommendations** from the analysis:

1. **Sectoral Risk Management**: Tourism's 48% impact requires targeted buffers and diversification incentives.

2. **External Demand Hedging**: 25% of shocks are external. Enhance EPF flexibility and export credit insurance.

3. **Fiscal Policy Design**: GST/subsidy changes have 8-quarter persistence. Phase adjustments gradually.

4. **Labor Market Resilience**: Gig economy volatility has 17-quarter half-life. Develop social protection for informal workers.

5. **Monetary Policy**: Fed spillovers show 6-8 quarter transmission. BNM should maintain forward guidance.`
            },
            'compare': {
                keywords: ['compare', 'versus', 'vs', 'difference', 'similarities'],
                response: `**COVID vs GFC Comparison:**

| Metric | COVID Lockdown | Global Financial Crisis |
|--------|---------------|-------------------------|
| **Peak Output** | 9.6% | 15% |
| **Half-life** | 1 quarter | 3 quarters |
| **Type** | TFP Shock | External Demand |
| **Recovery** | Fast (adaptation) | Moderate |
| **Consumption** | 6.2% | 15.6% |

**Key Insight**: COVID had sharper but shorter impact; GFC had broader, more persistent effects.`
            },
            'gig economy': {
                keywords: ['gig', 'informal', 'volatility', 'structural'],
                response: `**Gig Economy Volatility** is a structural concern:

â€¢ **Peak Output**: 5% (moderate)
â€¢ **Peak Consumption**: 13% (high â€” disproportionate impact)
â€¢ **Half-life**: 17 quarters (longest of all shocks!)
â€¢ **Informal sector share**: 32%

**Policy Implication**: Structural uncertainty creates the longest-lasting effects. Malaysia needs portable benefits for informal workers.`
            },
            'methodology': {
                keywords: ['methodology', 'model', 'how does it work', 'engramhank'],
                response: `**EngramHANK Methodology:**

**Phase 1: Memory (Engram)**
- Solve Master Equation (HJB + KFE) once
- Compute analytic Jacobians
- Cache with FNV-1a hash (O(1) retrieval)

**Phase 2: Reasoning (GE)**
- FFT Toeplitz arithmetic: O(T log T)
- Market clearing in deviation form
- ~32 iterations to convergence

**Speedup**: 1500Ã— cache hits vs recomputation
**Calibration**: BNM, DOSM, WID.world data`
            }
        };

        // System prompt for Cerebras
        const systemPrompt = `You are an expert economic research assistant specializing in HANK (Heterogeneous Agent New Keynesian) models and Malaysian macroeconomic analysis.

You have access to results from the EngramHANK model, which analyzed 20 major economic shocks in Malaysia from 2008-2025. The model uses:
- DeepSeek's Engram Architecture (memory-reasoning separation)
- Bilal's Continuous-Time SSJ methods
- O(T log T) FFT-based solver
- Calibration from BNM, DOSM, and WID data

Key data points to reference:
- Tourism Collapse (2020-2022): 48% peak output impact, 39% consumption
- Global Financial Crisis (2008-2009): 15% peak output
- COVID Lockdown (2020-Q2): 9.6% peak output, 1 quarter half-life
- Gig Economy Volatility: 17 quarter half-life (most persistent)
- Average GE convergence: 32 iterations
- Cache speedup: 1500Ã—

Be concise, professional, and cite specific numbers when possible. If asked about something outside the Malaysia shock analysis, acknowledge the limitation.`;

        // UI Functions
        function updateApiStatus() {
            const statusEl = document.getElementById('api-status');
            if (apiKey && apiKey.startsWith('csk-')) {
                statusEl.className = 'api-status connected';
                statusEl.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i><span>Cerebras Connected</span>';
            } else {
                statusEl.className = 'api-status disconnected';
                statusEl.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i><span>API Key Required</span>';
            }
        }

        function toggleApiKey() {
            const modal = document.getElementById('api-key-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('api-key-input').value = apiKey;
            }
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key && key.startsWith('csk-')) {
                apiKey = key;
                localStorage.setItem('cerebras_api_key', key);
                updateApiStatus();
                toggleApiKey();
                addMessage('Cerebras API key saved! You now have access to enhanced AI responses.', false);
            } else {
                alert('Please enter a valid Cerebras API key (starts with csk-)');
            }
        }

        // Chat Functions
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');

        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start';
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="ml-auto message-bubble bg-primary text-white rounded-lg p-4">
                        <p>${escapeHtml(text)}</p>
                    </div>
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center flex-shrink-0 ml-3">
                        <i class="fas fa-user text-gray-600 text-xs"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-br from-primary to-accent rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-white text-xs"></i>
                    </div>
                    <div class="ml-3 message-bubble bg-gray-100 rounded-lg p-4">
                        <div class="text-gray-800 prose prose-sm max-w-none">${formatResponse(text)}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatResponse(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code class="bg-gray-200 px-1 rounded">$1</code>')
                .replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex items-start';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-br from-primary to-accent rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-xs"></i>
                </div>
                <div class="ml-3 message-bubble bg-gray-100 rounded-lg p-4 typing-indicator">
                    <span class="text-gray-500">Thinking</span>
                    <span class="text-gray-500">.</span>
                    <span class="text-gray-500">.</span>
                    <span class="text-gray-500">.</span>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function findLocalResponse(query) {
            const lowerQuery = query.toLowerCase();
            for (const [key, data] of Object.entries(knowledgeBase)) {
                if (data.keywords.some(kw => lowerQuery.includes(kw))) {
                    return data.response;
                }
            }
            return null;
        }

        async function callCerebrasAPI(userMessage) {
            try {
                const response = await fetch(CEREBRAS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama3.1-70b',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('Cerebras API error:', error);
                return null;
            }
        }

        async function askQuestion(question) {
            userInput.value = question;
            await handleSubmit(new Event('submit'));
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            
            addMessage(text, true);
            userInput.value = '';
            showTypingIndicator();

            let response;
            
            if (apiKey && apiKey.startsWith('csk-')) {
                response = await callCerebrasAPI(text);
            }
            
            if (!response) {
                response = findLocalResponse(text);
            }
            
            if (!response) {
                response = `I can help you understand the Malaysian economic shock analysis results. Here are some things you can ask:

â€¢ What was the most severe economic shock?
â€¢ How does COVID compare to the GFC?
â€¢ What are the transmission channels?
â€¢ What policy recommendations emerge?
â€¢ How does the EngramHANK model work?

Try clicking one of the suggested questions above, or ask something specific about the 20 shocks analyzed (2008-2025).

${apiKey ? '' : 'ðŸ’¡ Tip: Add your Cerebras API key for enhanced AI responses!'}`;
            }
            
            hideTypingIndicator();
            addMessage(response, false);
        }

        chatForm.addEventListener('submit', handleSubmit);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                handleSubmit(e);
            }
        });

        updateApiStatus();
    </script>
</body>
</html>
